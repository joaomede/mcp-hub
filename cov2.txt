============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-8.4.2, pluggy-1.6.0 -- /bin/python3
cachedir: .pytest_cache
rootdir: /home/joao/Downloads/project/forks/mcp-hub
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-1.1.0, cov-6.3.0
asyncio: mode=strict, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 68 items

tests/unit/test_auth.py::test_verify_api_key_invalid PASSED              [  1%]
tests/unit/test_auth.py::test_verify_api_key_valid PASSED                [  2%]
tests/unit/test_auth_jwt.py::test_create_and_decode_token PASSED         [  4%]
tests/unit/test_auth_jwt.py::test_create_token_with_expiry FAILED        [  5%]
tests/unit/test_auth_jwt.py::test_decode_token_invalid PASSED            [  7%]
tests/unit/test_auth_jwt_extra.py::test_create_token_and_decode PASSED   [  8%]
tests/unit/test_auth_jwt_extra.py::test_create_token_expired PASSED      [ 10%]
tests/unit/test_auth_jwt_extra.py::test_decode_token_invalid PASSED      [ 11%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_invalid_bearer PASSED [ 13%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_valid_bearer PASSED [ 14%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_invalid_basic PASSED [ 16%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_valid_basic PASSED [ 17%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_unsupported_auth PASSED [ 19%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_missing_auth PASSED [ 20%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_invalid_basic_base64 PASSED [ 22%]
tests/unit/test_auth_middleware.py::test_apikeymiddleware_invalid_basic_no_colon PASSED [ 23%]
tests/unit/test_cli_init.py::test_cli_help PASSED                        [ 25%]
tests/unit/test_cli_init.py::test_cli_missing_command PASSED             [ 26%]
tests/unit/test_cli_init.py::test_cli_invalid_env PASSED                 [ 27%]
tests/unit/test_cli_init.py::test_cli_path_prefix_normalization PASSED   [ 29%]
tests/unit/test_config_watcher.py::test_config_watcher_triggers_reload PASSED [ 30%]
tests/unit/test_config_watcher_errors.py::test_config_watcher_invalid_json PASSED [ 32%]
tests/unit/test_config_watcher_errors.py::test_config_watcher_file_not_found PASSED [ 33%]
tests/unit/test_config_watcher_errors2.py::test_config_watcher_invalid_json FAILED [ 35%]
tests/unit/test_config_watcher_errors2.py::test_config_watcher_file_not_found PASSED [ 36%]
tests/unit/test_config_watcher_errors2.py::test_config_watcher_callback_exception FAILED [ 38%]
tests/unit/test_graceful_shutdown.py::test_graceful_shutdown_sets_event PASSED [ 39%]
tests/unit/test_graceful_shutdown.py::test_graceful_shutdown_track_task PASSED [ 41%]
tests/unit/test_graceful_shutdown_extra.py::test_graceful_shutdown_unexpected_signal PASSED [ 42%]
tests/unit/test_graceful_shutdown_extra.py::test_graceful_shutdown_track_task_done FAILED [ 44%]
tests/unit/test_graceful_shutdown_extra2.py::test_graceful_shutdown_track_task_done FAILED [ 45%]
tests/unit/test_graceful_shutdown_extra2.py::test_graceful_shutdown_handle_signal_sets_event PASSED [ 47%]
tests/unit/test_init.py::test_env_dict_parsing PASSED                    [ 48%]
tests/unit/test_main.py::test_validate_server_config_valid PASSED        [ 50%]
tests/unit/test_main.py::test_validate_server_config_missing_command PASSED [ 51%]
tests/unit/test_main_config_file.py::test_load_config_empty_file PASSED  [ 52%]
tests/unit/test_main_config_file.py::test_load_config_permission_denied PASSED [ 54%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[None] PASSED [ 55%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[123] PASSED [ 57%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[string] PASSED [ 58%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[server_cfg3] PASSED [ 60%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[server_cfg4] PASSED [ 61%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[server_cfg5] PASSED [ 63%]
tests/unit/test_main_config_types.py::test_validate_server_config_invalid_types[server_cfg6] PASSED [ 64%]
tests/unit/test_main_handlers.py::test_health_check PASSED               [ 66%]
tests/unit/test_main_handlers.py::test_sub_app_root_returns_405 PASSED   [ 67%]
tests/unit/test_main_handlers.py::test_sub_app_post_missing_session PASSED [ 69%]
tests/unit/test_main_http_filter.py::test_http_request_filter FAILED     [ 70%]
tests/unit/test_main_http_filter_extra.py::test_http_request_filter_blocks_info_http PASSED [ 72%]
tests/unit/test_main_http_filter_extra.py::test_http_request_filter_allows_other PASSED [ 73%]
tests/unit/test_main_mount_prefixes.py::test_mount_unmount_multiple_prefixes PASSED [ 75%]
tests/unit/test_main_mount_unmount.py::test_mount_and_unmount_servers PASSED [ 76%]
tests/unit/test_main_mount_unmount.py::test_create_sub_app_with_api_key PASSED [ 77%]
tests/unit/test_main_proxy.py::test_proxy_requires_initialize PASSED     [ 79%]
tests/unit/test_main_proxy_errors.py::test_proxy_method_not_found PASSED [ 80%]
tests/unit/test_main_reload.py::test_load_config_no_mcpservers PASSED    [ 82%]
tests/unit/test_main_reload.py::test_load_config_file_not_found PASSED   [ 83%]
tests/unit/test_main_reload.py::test_load_config_invalid_json PASSED     [ 85%]
tests/unit/test_main_reload.py::test_reload_config_handler_no_change PASSED [ 86%]
tests/unit/test_main_reload.py::test_reload_config_handler_add_remove PASSED [ 88%]
tests/unit/test_main_reload_partial.py::test_reload_config_handler_partial_changes FAILED [ 89%]
tests/unit/test_main_reload_rollback.py::test_reload_config_handler_rollback PASSED [ 91%]
tests/unit/test_main_reload_rollback.py::test_reload_config_handler_error PASSED [ 92%]
tests/unit/test_main_validation.py::test_validate_server_config_valid PASSED [ 94%]
tests/unit/test_main_validation.py::test_validate_server_config_missing_command PASSED [ 95%]
tests/unit/test_main_validation.py::test_load_config_valid PASSED        [ 97%]
tests/unit/test_main_validation.py::test_load_config_invalid PASSED      [ 98%]
tests/unit/test_utils_main.py::test_logger_exists PASSED                 [100%]

=================================== FAILURES ===================================
________________________ test_create_token_with_expiry _________________________

    def test_create_token_with_expiry():
        data = {"foo": "bar"}
        token = create_token(data, expires_delta=timedelta(seconds=1))
        decoded = decode_token(token)
        assert decoded["foo"] == "bar"
        time.sleep(1.5)
        # Após expirar, decode_token deve retornar None
>       assert decode_token(token) is None
E       AssertionError: assert {'exp': 1757320343, 'foo': 'bar'} is None
E        +  where {'exp': 1757320343, 'foo': 'bar'} = decode_token('eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmb28iOiJiYXIiLCJleHAiOjE3NTczMjAzNDN9.IgB0QYl_TqPick9sStci4NZDlW0k3bVGj5SIH1XvXqQ')

tests/unit/test_auth_jwt.py:20: AssertionError
_______________________ test_config_watcher_invalid_json _______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7efe5f6ec790>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7efe5f6ed300>

    def test_config_watcher_invalid_json(monkeypatch, caplog):
        # Cria arquivo temporário com JSON inválido
        with tempfile.NamedTemporaryFile("w+", delete=False) as f:
            f.write("{invalid json}")
            f.flush()
            path = f.name
    
        called = False
        async def reload_callback(cfg):
            nonlocal called
            called = True
    
        watcher = ConfigWatcher(path, reload_callback)
        caplog.set_level(logging.ERROR)
        try:
            watcher.start()
            # Força modificação
            os.utime(path, None)
            # Aguarda debounce e processamento
            asyncio.run(asyncio.sleep(1))
        finally:
            watcher.stop()
            os.unlink(path)
        # Deve logar erro de JSON
>       assert any("Invalid JSON" in r.message for r in caplog.records)
E       assert False
E        +  where False = any(<generator object test_config_watcher_invalid_json.<locals>.<genexpr> at 0x7efe600a1af0>)

tests/unit/test_config_watcher_errors2.py:34: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    mcp_hub.utils.config_watcher:config_watcher.py:135 No running event loop found, cannot start config watcher
____________________ test_config_watcher_callback_exception ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7efe5f6ec730>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7efe5f6ecc40>

    def test_config_watcher_callback_exception(monkeypatch, caplog):
        # Cria arquivo temporário com JSON válido
        with tempfile.NamedTemporaryFile("w+", delete=False) as f:
            json.dump({"foo": 1}, f)
            f.flush()
            path = f.name
    
        async def reload_callback(cfg):
            raise RuntimeError("callback error")
    
        watcher = ConfigWatcher(path, reload_callback)
        caplog.set_level(logging.ERROR)
        try:
            watcher.start()
            os.utime(path, None)
            asyncio.run(asyncio.sleep(1))
        finally:
            watcher.stop()
            os.unlink(path)
>       assert any("callback error" in r.message for r in caplog.records)
E       assert False
E        +  where False = any(<generator object test_config_watcher_callback_exception.<locals>.<genexpr> at 0x7efe600a3d10>)

tests/unit/test_config_watcher_errors2.py:68: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    mcp_hub.utils.config_watcher:config_watcher.py:135 No running event loop found, cannot start config watcher
____________________ test_graceful_shutdown_track_task_done ____________________

    @pytest.mark.asyncio
    async def test_graceful_shutdown_track_task_done():
        shutdown = GracefulShutdown()
        async def dummy():
            return 42
        task = asyncio.create_task(dummy())
        await task
        shutdown.track_task(task)
        # Task já finalizada deve ser removida imediatamente
>       assert task not in shutdown.tasks
E       AssertionError: assert <Task finished name='Task-80' coro=<test_graceful_shutdown_track_task_done.<locals>.dummy() done, defined at /home/joao/Downloads/project/forks/mcp-hub/tests/unit/test_graceful_shutdown_extra.py:18> result=42> not in {<Task finished name='Task-80' coro=<test_graceful_shutdown_track_task_done.<locals>.dummy() done, defined at /home/joao/Downloads/project/forks/mcp-hub/tests/unit/test_graceful_shutdown_extra.py:18> result=42>}
E        +  where {<Task finished name='Task-80' coro=<test_graceful_shutdown_track_task_done.<locals>.dummy() done, defined at /home/joao/Downloads/project/forks/mcp-hub/tests/unit/test_graceful_shutdown_extra.py:18> result=42>} = <mcp_hub.main.GracefulShutdown object at 0x7efe5f6ece20>.tasks

tests/unit/test_graceful_shutdown_extra.py:24: AssertionError
____________________ test_graceful_shutdown_track_task_done ____________________

    def test_graceful_shutdown_track_task_done():
        shutdown = GracefulShutdown()
        async def dummy():
            return 42
>       task = asyncio.create_task(dummy())

tests/unit/test_graceful_shutdown_extra2.py:11: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

coro = <coroutine object test_graceful_shutdown_track_task_done.<locals>.dummy at 0x7efe5f7505f0>

    def create_task(coro, *, name=None):
        """Schedule the execution of a coroutine object in a spawn task.
    
        Return a Task object.
        """
>       loop = events.get_running_loop()
E       RuntimeError: no running event loop

/usr/lib/python3.10/asyncio/tasks.py:336: RuntimeError
___________________________ test_http_request_filter ___________________________

    def test_http_request_filter():
        # Instancia o filtro
        f = None
        for name, obj in mcp_logging.__dict__.items():
            if name == "HTTPRequestFilter":
                f = obj
                break
>       assert f is not None
E       assert None is not None

tests/unit/test_main_http_filter.py:18: AssertionError
__________________ test_reload_config_handler_partial_changes __________________

    @pytest.mark.asyncio
    async def test_reload_config_handler_partial_changes():
        app = FastAPI()
        app.state.config_data = {"mcpServers": {"srv1": {"command": "echo", "args": ["foo"]}, "srv2": {"command": "echo", "args": ["bar"]}}}
        app.state.cors_allow_origins = ["*"]
        app.state.api_key = None
        app.state.strict_auth = False
        app.state.api_dependency = None
        app.state.connection_timeout = 5
        app.state.lifespan = None
        app.state.path_prefix = "/"
        # Remove srv1, mantém srv2, adiciona srv3
        new_config = {"mcpServers": {"srv2": {"command": "echo", "args": ["bar"]}, "srv3": {"command": "echo", "args": ["baz"]}}}
        await reload_config_handler(app, new_config)
        paths = [str(route.path) for route in app.router.routes if hasattr(route, 'path')]
>       assert any("/srv2/mcp" in p for p in paths)
E       assert False
E        +  where False = any(<generator object test_reload_config_handler_partial_changes.<locals>.<genexpr> at 0x7efe5f760660>)

tests/unit/test_main_reload_partial.py:21: AssertionError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.10.12-final-0 _______________

Name                                  Stmts   Miss Branch BrPart  Cover   Missing
---------------------------------------------------------------------------------
src/mcp_hub/__init__.py                  46      7     24      6    81%   74->87, 84-85, 90, 99->103, 101, 105-106, 110
src/mcp_hub/main.py                     381    111    120     18    67%   53, 124->127, 181-185, 217, 231-233, 256-261, 328, 332-334, 380-445, 465-467, 514, 530, 532, 555, 567, 578-598, 603-609, 629-634, 649->663, 654-659, 676-677, 681-689, 693
src/mcp_hub/utils/auth.py                61      4     18      2    92%   24, 51, 100-101
src/mcp_hub/utils/config_watcher.py     101     23     18      1    73%   41, 45-56, 60-71, 90-91, 108, 111-112, 158-159, 162
src/mcp_hub/utils/main.py                 2      0      0      0   100%
---------------------------------------------------------------------------------
TOTAL                                   591    145    180     27    72%
=========================== short test summary info ============================
FAILED tests/unit/test_auth_jwt.py::test_create_token_with_expiry - Assertion...
FAILED tests/unit/test_config_watcher_errors2.py::test_config_watcher_invalid_json
FAILED tests/unit/test_config_watcher_errors2.py::test_config_watcher_callback_exception
FAILED tests/unit/test_graceful_shutdown_extra.py::test_graceful_shutdown_track_task_done
FAILED tests/unit/test_graceful_shutdown_extra2.py::test_graceful_shutdown_track_task_done
FAILED tests/unit/test_main_http_filter.py::test_http_request_filter - assert...
FAILED tests/unit/test_main_reload_partial.py::test_reload_config_handler_partial_changes
======================== 7 failed, 61 passed in 10.19s =========================
